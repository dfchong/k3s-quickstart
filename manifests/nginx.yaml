---
apiVersion: v1
kind: Namespace
metadata:
  name: test
  labels:
    istio-injection: enabled

---
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: test-credential
  namespace: istio-system
data:
  cert: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZOakNDQXg2Z0F3SUJBZ0lERUFJU01BMEdDU3FHU0liM0RRRUJDd1VBTUVFeEN6QUpCZ05WQkFZVEFsVlQKTVE4d0RRWURWUVFJREFaRVpXNXBZV3d4RERBS0JnTlZCQW9NQTBScGN6RVRNQkVHQTFVRUF3d0tibWRwYm5ndQpkR1Z6ZERBZUZ3MHhPVEEyTWpneE9UQTFNekJhRncweU1EQTNNRGN4T1RBMU16QmFNRmN4Q3pBSkJnTlZCQVlUCkFsVlRNUTh3RFFZRFZRUUlEQVpFWlc1cFlXd3hGREFTQmdOVkJBY01DMU53Y21sdVoyWnBaV3hrTVF3d0NnWUQKVlFRS0RBTkVhWE14RXpBUkJnTlZCQU1NQ201bmFXNTRMblJsYzNRd2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQQpBNElCRHdBd2dnRUtBb0lCQVFDa3U2MWZuaHcxNm14RXpka2pYQ0xMd1Bhdm1xRUkzMFVIRXd2bXVFWWlRS01kCjJ1NGJJd0g0MU15cEhEMTlENnpTRFdaeHVJUkhLZ3lLemRDSi9TOEVZTi9ONXhuUTBzdVJ3VWFEeml5Q0wrRGMKOFk5YmRZekloRitNeXVhTlZyMzR1eWkvOVlic1l3NFRiNTFwa1kvUU1KMit4M3p2L0NCeDR3TXc1MVFpUS9KdwpLdUlrM1UvczhtYTNqY01iMTVGSFFHSVBUcXhyQUpBQnRmQVRPcjU0NlMyWUhZY3MvYXVmMUVkM2VsaG9aNG10ClpiOXppL3hIM0lwWEszcm4wazdKMk1UTXZLUm1lQUtmanRsMFNiMmlHbUJUdEd4eitqSUp0OUtiU0JFVmZGd0oKUmJ5ZXNZMGFpZCtsWTRFN1g1MmRlSTJwN25EUS94TlIxRnAyZEJLRkFnTUJBQUdqZ2dFZk1JSUJHekFKQmdOVgpIUk1FQWpBQU1CRUdDV0NHU0FHRytFSUJBUVFFQXdJR1FEQXpCZ2xnaGtnQmh2aENBUTBFSmhZa1QzQmxibE5UClRDQkhaVzVsY21GMFpXUWdVMlZ5ZG1WeUlFTmxjblJwWm1sallYUmxNQjBHQTFVZERnUVdCQlFIK1FaV0E5RWIKUDBXOXBneFkvRTBMRkpKME5UQ0JnUVlEVlIwakJIb3dlSUFVK2NMTThoMnFETGF3cmlTSTNSMWJsOTQwSEkraApXNlJaTUZjeEN6QUpCZ05WQkFZVEFsVlRNUTh3RFFZRFZRUUlEQVpFWlc1cFlXd3hGREFTQmdOVkJBY01DMU53CmNtbHVaMlpwWld4a01Rd3dDZ1lEVlFRS0RBTkVhWE14RXpBUkJnTlZCQU1NQ201bmFXNTRMblJsYzNTQ0F4QUMKRWpBT0JnTlZIUThCQWY4RUJBTUNCYUF3RXdZRFZSMGxCQXd3Q2dZSUt3WUJCUVVIQXdFd0RRWUpLb1pJaHZjTgpBUUVMQlFBRGdnSUJBSndlQ3BvSlc3aWZwSzl3VytOdFRLUG1VcXQ4ZmZRYU1rUE15cTNHSFdsMmlENkJ5MTVrCkJKd0tWY1B5RFFHdm9jamhlQ2FrS2xSWjdIUHdLTjluSER0Qmt0TEFOWUtUSEM3QjNVU3VOMjFSYmNEelMrT3kKNncvcVBuVzNKVkp1VXl5ZnZONEhJbGJaOHFWVmQreVp3NzF6ZkYwSUUzY1dnMEI4UDBxTlBpNHRNNUQycC80RQpQUks2WGlWSmxicXVWOHM0WUQ2a0FnbXVGUFBEbVh3R0MwaDJNaUU5dWJOSDFNY2lNL05NZGJLeWVCeCtiMSt6Cm9Nd3pEcnBKZ3lIbDJ1NkxxOGxuTVNEMEY0ekY1U1RPY1Q5b0Zad0QxYysxcHc2cUs5OUluc1UvL0FtbjhDM1QKOUt3UlZnZS8ydVp1OHdaS00wK1JoZThBQjV4M25Sb2tHRUlwRVBWd3l4MkF3QzRYdnh6dnl4Rm5lbGlLcCswaQpJUC9nblN0cnpqTUpDVmF2WW90VWdRTnNYbHE2Z3Z5akdZb2cxeWh6UVluM01jcDREWG8zMWZIbytkc3VPWHVSClR4MXRkUUw5Mlc2Ym95YkxGMERKanFmVCtMZDI3TDJKazhmOXE2cnpiMmx6MllnVit3aEVTeWMvazlzazJ4eXAKaWVNcTZBbFFNY2FUTmpNUDBoTDFXRkF4dHBqOXJRaWp5TVE1QjNqMW12RFlVbytPREg2alNydjZDWHNZdkRQTwo0T2dJVjdCTFhObzczUjdmK2FuNjQ2WFFlQ0JUSFRZV0dWbVoxQVpHeXgzYW9CR2tRSkxLQ3JrT0lyQllBU1NhCjh2T3pEVDlORmR6NmRqZ05DczV0NW9JWmJHV2J4WjdoYkZ4eEZPVTRCUG1SaWtKbGRlcFRxa0R3Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBcEx1dFg1NGNOZXBzUk0zWkkxd2l5OEQycjVxaENOOUZCeE1MNXJoR0lrQ2pIZHJ1Ckd5TUIrTlRNcVJ3OWZRK3MwZzFtY2JpRVJ5b01pczNRaWYwdkJHRGZ6ZWNaME5MTGtjRkdnODRzZ2kvZzNQR1AKVzNXTXlJUmZqTXJtalZhOStMc292L1dHN0dNT0UyK2RhWkdQMERDZHZzZDg3L3dnY2VNRE1PZFVJa1B5Y0NyaQpKTjFQN1BKbXQ0M0RHOWVSUjBCaUQwNnNhd0NRQWJYd0V6cStlT2t0bUIySExQMnJuOVJIZDNwWWFHZUpyV1cvCmM0djhSOXlLVnl0NjU5Sk95ZGpFekx5a1puZ0NuNDdaZEVtOW9ocGdVN1JzYy9veUNiZlNtMGdSRlh4Y0NVVzgKbnJHTkdvbmZwV09CTzErZG5YaU5xZTV3MFA4VFVkUmFkblFTaFFJREFRQUJBb0lCQUdYQlVDeTZHNjdxS1FxdgpKS3VFNURGNzltVXVYTDZBTzhGTThKTUp6TGludUpwZWU2bmppL3BLYUVrbG1vMi91djdkTENTZTE0YWw0SzEwCnlKWVVBSkR4emd6LzdhQmlOVURKWkdkU1dZZnBUenJyTTZSSkRqZG1IU2Q0eGNVVWliQTAyODBIT3RxVnJVSXcKTmNuYUVqMkZha3RJS2xLTEtQZHdSSzVXbGsrN0x6Vm5uQUpadGdhVnlhN3hZaDJQNDl1aUg1a3FKOTNjUlA3YgpCalJwNlhobUJ2MHVqY0tDOUpwMFFYdFBuV2xSQnlNUG5pUlpvbFIyeEZVN0hZbGE0WXJkZzF2dHhHZnJMUXNmCmJGTXFSOGg3eGN5Y3ZBZmJWbmxaYlJiR3JoOXdUMFNBUUhuaXRVbG9XVGVPaFJJdWtXOWIyaEhvamxXMjByUjMKS2Q2aE9Ga0NnWUVBejNOWkRvOFdzbnlWU2J5SnZmQlZnRXRJRnpHMEdMQnJOYXA5S29PdFEwSzFJYkJlcEJ4dApOODJiSXRsbVdYb05OLzR3WGcxOUpkWkx3NjRrMlMrSldEWmUyUi8yeXZBWlVTaHJxKzdBTVFOZ2owRjhWMU0rClhwWWYwWmdKUTZQMzZ5R0RIWVJEdU9HR2FaSzBvcDdsVHUwWnNadnJ0YXIxTjJkVFdDTTIya2NDZ1lFQXkwa1IKR3l1enhJZmdkUENnRW50ZGJnK1pYVXcxWndUOUJSTitaeFkxL0dlcjFmU2k3Z2s4bmZxM0k0aFVkL3pyaVRHegpud1NZMU0rN2k0N2NqRjRrbUg0QnNPNHFuRm5uSGVRdW1pS3VDMVRhb3FvcDlyZ2tYbkc4TmhTcG14UjNXK1I4CjBEQU1oZ3dVTStPQ1c5U2w1TGNYUng0L0NJTWhVVlFDMG1lYmh0TUNnWUJhZkd1NkIvdlVlcmI3Wkx1SUY4NlQKbVVLbXEwMXMvM2FqLyt0OG9kYnZZYWQwUEdQcm5XS2VWcFoyaXZFejBpTDE2Mi9aZG5UQ0Rra1ozMW0vU2hiVQpYVkxkemkxdHMzQzNqN1AzV0xxSUpucjF3WkNrM25Cei9YTi9qcHRyMzVlQi9pb2NzOVorVEJDKzkvakdmaHh6CllzUTBUbGh2ODFQbWlMRTMzcFJNZlFLQmdEbDBsbFFpbnZXT0hkK1BYdjY2UldibEc4aWwwSFlrajhyT2ZxeHUKTjZYMk96Z0dvOEk1ZEJ1R2tCcUgzcS9uR1Q4MmYva1MySXRWaDBGamlHeFg4Mm55TzFJaGpvT1FXV1UyYUFHQwppY1NFSUNOWGl2TERpdXZ5bzJwNW5wSkpUNDcyWGx5TktBeisvdnJIYzhHMnNZaWFRd2NEd25jS2NQRkdtR0dWCmpQeW5Bb0dBRXhNa0trM045Sm16RWkzOFNKcHpDSEdFWGt2NnMrbWVTU0JpdDJNOVluNHQyMjZWMW9rRWh5Q0UKdzJSUllaZFRKNWVsQ3pQSlp4NFpnYStlYndtNHN6OHBjS0dXeGdrbURxSmlvbTNZeFdTbU1GcTV1MnNCVTE0bQpxd3FMbDNHUEdlc2s1ZnpCbVJweHIwYWs2RkRoRFZPL2JweEgvTmwrZHEvQ3hJMmdzaTg9Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==

---
apiVersion: v1
kind: Service
metadata:
  name: nginx
  namespace: test
  labels:
    app: nginx
spec:
  ports:
    - port: 80
      name: http
  selector:
    app: nginx

---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: nginx
  namespace: test
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1G

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: test
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 1
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.17
          ports:
            - containerPort: 80
          volumeMounts:
            - name: nginx
              mountPath: /usr/share/nginx/html
      volumes:
        - name: nginx
          persistentVolumeClaim:
            claimName: nginx

---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: nginx
  namespace: test
spec:
  selector:
    istio: ingressgateway
  servers:
    - hosts:
        - nginx.test
      port:
        number: 80
        name: http
        protocol: HTTP
      tls:
        httpsRedirect: true
    - hosts:
        - nginx.test
      port:
        number: 443
        name: https
        protocol: HTTPS
      tls:
        mode: SIMPLE
        credentialName: test-credential

---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: nginx
  namespace: test
spec:
  hosts:
    - nginx.test
  gateways:
    - nginx
  http:
    - match:
        - uri:
            prefix: /
      route:
        - destination:
            port:
              number: 80
            host: nginx
